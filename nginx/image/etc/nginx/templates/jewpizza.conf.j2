{%- macro server_name() -%}
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    ssl_certificate /etc/letsencrypt/live/jew-pizza/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/jew-pizza/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/jew-pizza/chain.pem;
    ssl_dhparam /etc/letsencrypt/dhparams/dhparam.pem;

    {% if varargs %}
        {% for subdomain in varargs %}
            server_name {% if subdomain == '_' %}_{% else %}{{ subdomain }}.{{ DOMAIN_NAME }}{% endif %};  # certbot_domain:*.{{ DOMAIN_NAME }}
        {% endfor %}
    {% else %}
        server_name {{ DOMAIN_NAME }};
    {% endif %}
{%- endmacro -%}

# Cache values
map $sent_http_content_type $expires {
    default                    off;
    text/html                  epoch;
    text/css                   30d;
    application/javascript     30d;
    ~image/                    30d;
    ~font/                     30d;
}

upstream app { server app:8000; }
upstream logs { server logs:8080; }
upstream sse { server sse:8001; }
upstream umami { server umami:3000; }
upstream icecast { server icecast:8888; }

# {{ DOMAIN_NAME }}, main Django app
server {
    {{ server_name() }}

    include proxy_busy_error;

    location = /favicon.ico {
        return 204;
        access_log off;
        log_not_found off;
    }

    {% if not DEBUG|int %}
        # /static and /media enabled when DEBUG=1
        location /static {
            expires $expires;
            alias /static_root;
        }

        location /media {
            expires $expires;
            alias /media_root;
        }
    {% else %}
        # /static and /media disabled when DEBUG=0
    {% endif -%}

    # sse service
    location /sse/ {
        include proxy_params;
        proxy_buffering off;
        proxy_cache off;
        proxy_pass http://sse/;
    }

    # Logs service only accessible by X-Accel-Redirect in Django app (internal)
    location /protected/cmsadmin/tools/logs/ {
        internal;
        include proxy_params;
        proxy_buffering off;
        proxy_cache off;
        proxy_pass http://logs/cmsadmin/tools/logs/;
    }

    location / {
        include proxy_params;
        proxy_pass http://app;
    }
}

# Umami analytics
server {
    {{ server_name('umami', 'analytics') }}

    include proxy_busy_error;

    # uBlockOrigin breaks /umami.js
    location = /script.js {
        rewrite ^.*$ /umami.js last;
    }

    location / {
        include proxy_params;
        proxy_pass http://umami;
    }
}

# radio service
server {
    {{ server_name('radio') }}

    include proxy_busy_error;

    location / {
        include proxy_params;
        proxy_pass http://icecast;
    }
}

{% for subdomain, enabled in (
    ('etc', NGINX_ENABLE_ETC_SUBDOMAIN|default(0)|int),
    ('priv', NGINX_ENABLE_PRIV_SUBDOMAIN|default(0)|int),
) %}
    {% if enabled %}
        # {{ subdomain }}, served folder enabled by config
        server {
            {{ server_name(subdomain) }}

            root /{{ subdomain }}_root;
            {% if subdomain == 'etc' %}autoindex on;{% endif %}

            location = /robots.txt {
                add_header Content-Type text/plain;
                return 200 "User-agent: *\nDisallow: /\n";
            }

            location / {
                try_files $uri $uri/ =404;
            }
        }
    {% endif %}
{% endfor %}

# Catch-all subdomain redirect to Django app (include www.{{ DOMAIN_NAME }})
server {
    {{ server_name('_') }}

    return 302 https://{{ DOMAIN_NAME }}$request_uri;
}
