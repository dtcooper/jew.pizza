services:
  app:
    build:
      context: .
      args:
        - "DEBUG=${DEBUG:-0}"
    volumes:
      - ./.env:/.env:ro
      - ./serve/static:/static_root
      - ./serve/media:/media_root
    depends_on:
      - db
      - redis
    restart: always
    ports:
      - "${BIND_ADDR:-127.0.0.1:8000}:8000"
    environment:
      - "TZ=${TIMEZONE:-US/Eastern}"

  tasks:
    build:
      context: .
      args:
        - "DEBUG=${DEBUG:-0}"
    volumes:
      - ./.env:/.env:ro
    depends_on:
      - db
      - redis
    restart: always
    environment:
      - RUN_HUEY=1
      - "TZ=${TIMEZONE:-US/Eastern}"

  radio:
    build:
      context: radio
      args:
        - "DEBUG=${DEBUG:-0}"
    restart: always
    environment:
      - SECRET_KEY
      - SCRIPT_NAME=radio
      - "TZ=${TIMEZONE:-US/Eastern}"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  sse:
    build:
      context: sse
    restart: always
    volumes:
      - ./.env:/.env:ro
    depends_on:
      - redis
    ports:
      - "${SSE_BIND_ADDR:-127.0.0.1:8001}:8001"

  controller:
    build:
      dockerfile: Dockerfile.controller
    restart: always
    init: true
    volumes:
      - .:/app
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - "COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME:-jewpizza}"

  db:
    image: library/postgres:14-alpine
    restart: always
    volumes:
      - postgres_data:/var/lib/postgresql/data/
      - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
    environment:
      - POSTGRES_PASSWORD=postgres
      - "TZ=${TIMEZONE:-US/Eastern}"

  redis:
    image: library/redis:6-alpine
    restart: always
    volumes:
      - redis_data:/data
    environment:
      - "TZ=${TIMEZONE:-US/Eastern}"

  # nchan:
  #   image: rookiezoe/nginx
  #   #restart: always
  #   ports:
  #     - "127.0.0.1:8888:80"

  umami:
    image: ghcr.io/mikecao/umami:postgresql-2575cbf
    restart: always
    ports:
      - "${UMAMI_BIND_ADDR:-127.0.0.1:3000}:3000"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/umami
      - DATABASE_TYPE=postgresql
      # SECRET_KEY needs to be set in order to run this container
      - "HASH_SALT=${SECRET_KEY}"
      - "TZ=${TIMEZONE:-US/Eastern}"
    depends_on:
      - db

  logs:
    image: amir20/dozzle:latest
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "${LOGS_BIND_ADDR:-127.0.0.1:8888}:8080"
    environment:
      - DOZZLE_TAILSIZE=2500
      - DOZZLE_NO_ANALYTICS=true
      - "TZ=${TIMEZONE:-US/Eastern}"

volumes:
  postgres_data:
  redis_data:
